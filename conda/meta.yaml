{% set pyproject = load_file_data('../pyproject.toml', from_recipe_dir=True) %}
{# Align version with the one computed by setuptools_scm #}
{% set base_tag = GIT_DESCRIBE_TAG | default("0.1.0.dev0") | replace("v", "") %}
{% set distance = GIT_DESCRIBE_NUMBER | default("0") | int %}
{% set base_parts = base_tag.split('.') %}
{% set micro = base_parts[2] | int %}
{% set next_version = base_parts[0] + "." + base_parts[1] + "." + (micro + 1)|string %}
{% set scm_version = next_version + ".dev" + distance|string if distance > 0 else base_tag %}
{% set version = environ.get('SETUPTOOLS_SCM_PRETEND_VERSION', scm_version) %}

package:
  name: {{ pyproject["project"]["name"] }}
  version: {{ version }}

source:
  path: ..

build:
  noarch: python
  string: py{{ PY_VER }}
  preserve_egg_dir: True
  # pip install options mainly ensure that dependencies are handled by conda (and not pip)
  # --no-deps ensure pip will not install deps not declared in meta.yaml (but declared in pyproject.toml)
  # --no-build-isolation ensure pip will not replace build deps declared in meta.yaml (and declared in pyproject.toml)
  # --ignore-installed ensure that compiled files (accidentally present in sources or uncleaned locally) will be overwritten
  script: {{ PYTHON }} -m pip install . --no-deps --ignore-installed --no-build-isolation -vv

requirements:
  build:
    - python
    {% for dep in pyproject["build-system"]["requires"] %}
    - {{ dep.lower() }}
    {% endfor %}

  run:
    - python {{ pyproject["project"]["requires-python"] }}
    {% for dep in pyproject["project"]["dependencies"] %}
    - {{ dep.lower() }}
    {% endfor %}

test:
  requires:
    {% for dep in pyproject["project"]["optional-dependencies"]["test"] %}
    - {{ dep.lower() }}
    {% endfor %}
  imports:
    - {{ pyproject["project"]["name"] }}
  source_files:
    - test/test_*.py
    - doc/notebooks/*.ipynb
  commands:
   - pytest -v
   - pytest --nbmake


about:
  home: {{ pyproject["project"]["urls"]["Homepage"] }}
  license: {{ pyproject["project"]["license"] }}
  summary: {{ pyproject["project"]["description"] }}